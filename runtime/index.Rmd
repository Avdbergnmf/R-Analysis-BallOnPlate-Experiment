---
title: "VFD for gait variability"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll # scroll # fill
runtime: shinyrmd
---

```{r setup, include=FALSE}
# to reset:
# Kill ALL R processes (including your current session - use with caution!)
# system("pkill -f '^R$|Rterm|rsession'")
# Kill all background R processes
# system("pkill -f 'R --slave'", wait = FALSE)
# system("pkill -f 'Rscript'", wait = FALSE)
# system("pkill -f 'parallel'", wait = FALSE)

rmarkdown::shiny_prerendered_clean("workspace/index.Rmd") # we need to clear else it doesnt start the interface for whatever reason.

# Configuration variables are now centralized in source/initialization.R

source("source/setup.R")

# Create main application logger
app_logger <- create_module_logger("APP")

# Set up logging configuration for the application
app_logger("INFO", "Initializing BallOnPlate Game Experiment dashboard...")
app_logger("DEBUG", "Logging system loaded and configured")

# Gait event detection is now loaded on-demand via the gait feature module

# =============================================================================
# ENSURE INITIALIZATION IS COMPLETE
# =============================================================================
# Ensure all global data and parameters are properly loaded
# (This is now handled automatically by the loading process)
app_logger("INFO", "Ensuring global data initialization...")
ensure_global_data_initialized()
app_logger("DEBUG", "Global data initialization completed")

# File paths (using centralized parameters)
agpFile <- file.path(resultsFolder, "allGaitParams.rds")
aqrFile <- file.path(resultsFolder, "allQResults.rds")
simDataFile <- file.path(resultsFolder, "allSimulationData.rds")
taskMetricsFile <- file.path(resultsFolder, "allTaskMetrics.rds")
complexityMetricsFile <- file.path(resultsFolder, "allComplexityMetrics.rds")



# Create UDP time trim info for all participants and trials for improved performance
app_logger("DEBUG", "Loading UDP time trim info...")
udpTimeTrimInfoFile <- file.path(resultsFolder, "udpTimeTrimInfo.rds")
udpTimeTrimInfo <<- load_or_calculate(udpTimeTrimInfoFile, load_or_create_udp_time_trim_info)
app_logger("DEBUG", "UDP time trim info loaded")

# Load or calculate the data using the global parallel setting
app_logger("INFO", "Loading main data objects...")
allQResults <<- load_or_calculate(aqrFile, get_all_questionnaire_results, parallel = FALSE) # because its such a small operation, not running parallel is faster
app_logger("DEBUG", "Questionnaire results loaded")
allGaitParams <<- load_or_calculate(agpFile, calc_all_gait_params)
app_logger("DEBUG", "Gait parameters loaded")

dataTypes <- setdiff(getTypes(allGaitParams), categories)

# Load remaining data objects
app_logger("INFO", "Loading remaining data objects...")
allTaskMetrics <<- load_or_calculate(taskMetricsFile, get_all_task_metrics)
app_logger("DEBUG", "Task metrics loaded")

# Check if task data was just calculated to prevent complexity calculation bug
if (exists(".TASK_DATA_JUST_CALCULATED", envir = .GlobalEnv) &&
  isTRUE(.GlobalEnv$.TASK_DATA_JUST_CALCULATED)) {
  app_logger("WARN", "Complexity calculation skipped - task data was calculated in this session")
  app_logger("WARN", "This causes a known bug when running complexity calculation immediately after")
  app_logger("INFO", "SOLUTION: restart the R session to reset the flag, then run complexity calculation again")
  allComplexityMetrics <<- NULL
} else {
  app_logger("DEBUG", "Loading complexity metrics...")
  allComplexityMetrics <<- load_or_calculate(complexityMetricsFile, get_all_complexity_metrics, stop_cluster = TRUE)
  app_logger("DEBUG", "Complexity metrics loaded")
}
app_logger("INFO", "All data objects loaded successfully")


app_logger("INFO", "Dashboard initialization complete")

# for testing combining of tables
# mu_gait <- get_full_mu(allGaitParams, categories, TRUE, FALSE)
# prepped_q <- prep_questionnaire_for_merge(allQResults)
# mu_combined <- merge_mu_with_data(mu_gait, prepped_q,                 data_type_name = "questionnaire")
# mu_combined <- merge_mu_with_data(mu_combined, allTaskMetrics,        data_type_name = "task")
# mu_combined <- merge_mu_with_data(mu_combined, allComplexityMetrics,  data_type_name = "complexity")
```

Sidebar {.sidebar}
=====================================
```{r, child='pages/sidebar_dynamicDataFiltering.Rmd'}
```

```{r, context="server", local=FALSE}
session$allowReconnect(TRUE)

refresh_trigger <- reactiveVal(0) # used for refreshing filteredGaitParams after outlier update

# Custom function used to render SVG's instead of png's
renderSVG <- function(expr) {
  renderImage(
    {
      # Dynamically get width and height from input
      dpi <- 96
      width_value <- input$plotwidth / dpi
      height_value <- input$plotheight / dpi

      file <- htmltools::capturePlot(
        expr(), tempfile(fileext = ".svg"),
        grDevices::svg,
        width = width_value, height = height_value
      )
      list(src = file, deleteFile = TRUE)
    },
    deleteFile = TRUE
  )
}
```

Data Dictionary.md {data-orientation=columns}
=====================================
```{r, echo=FALSE}
shiny::includeMarkdown("data_dictionary.md")
```

Feet trajectories {data-orientation=columns}
=====================================
```{r, child='pages/page1_feetTrajectories.Rmd'}
```


Removed Steps
=====================================
```{r, child='pages/page2_removedSteps.Rmd'}
```


Raw tracker data {data-orientation=columns}
=====================================
```{r, child='pages/page3_rawTrackerData.Rmd'}
```


Histograms 
=====================================
```{r, child='pages/page5_histograms.Rmd'}
```


Scatterplots
=====================================
```{r, child='pages/page6_scatterplots.Rmd'}
```

Questionnaires 
=====================================
```{r, child='pages/page8_questionnaires.Rmd'}
```

Boxplots 
=====================================
```{r, child='pages/page9_boxplots.Rmd'}
```

Statistics {data-icon="fa-chart-bar"}
=====================================
```{r, child='pages/page10_statistics.Rmd'}
```

Correlations {data-icon="fa-chart-line"}
=====================================
```{r, child='pages/page11_correlations.Rmd'}
```

Participant Summary {data-icon="fa-id-card-clip"}
=====================================
```{r, child='pages/page12_participantSummary.Rmd'}
```

Data Table {data-icon="fa-table"}
=====================================
```{r, child='pages/page13_table.Rmd'}
```

Y-Rotation Correction
=====================================
```{r, child='pages/page14_dataCorrection.Rmd'}
```

Manual Outlier Filtering
=====================================
```{r, child='pages/page16_manualOutlierFiltering.Rmd'}
```

Simulation Data
=====================================
```{r, child='pages/page17_simulationData.Rmd'}
```

```{js}
// Last visited page persistence for flexdashboard
$(function() {
  // Check if localStorage is available
  function isLocalStorageAvailable() {
    try {
      const test = '__localStorage_test__';
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
      return true;
    } catch(e) {
      return false;
    }
  }
  
  if (!isLocalStorageAvailable()) {
    console.log('localStorage not available - page persistence disabled');
    return;
  }
  
  // Function to restore last visited page
  function restoreLastPage() {
    try {
      const savedHash = localStorage.getItem('lastVisitedPage');
      console.log('Attempting to restore page:', savedHash);
      
      if (savedHash && savedHash !== '#') {
        // Find the tab link for the saved hash
        const targetLink = document.querySelector('a[href="' + savedHash + '"]');
        
        if (targetLink) {
          console.log('Found target link, clicking to navigate to:', savedHash);
          // Trigger a click on the tab to properly activate flexdashboard navigation
          targetLink.click();
        } else {
          console.log('Saved page not found, clearing:', savedHash);
          localStorage.removeItem('lastVisitedPage');
        }
      } else {
        console.log('No saved page found or empty hash');
      }
    } catch(e) {
      console.error('Error restoring last page:', e);
    }
  }
  
  // Function to save current page
  function saveCurrentPage() {
    try {
      const currentHash = window.location.hash;
      if (currentHash && currentHash !== '#') {
        localStorage.setItem('lastVisitedPage', currentHash);
        console.log('Saved current page:', currentHash);
      }
    } catch(e) {
      console.error('Error saving current page:', e);
    }
  }
  
  // Function to wait for flexdashboard to be fully loaded
  function waitForFlexdashboard(callback, maxAttempts = 10, attempt = 1) {
    // Check if flexdashboard navigation is ready
    const navLinks = document.querySelectorAll('.navbar-nav a[href^="#"]');
    
    if (navLinks.length > 0) {
      console.log('Flexdashboard navigation ready, found', navLinks.length, 'nav links');
      callback();
    } else if (attempt < maxAttempts) {
      console.log('Flexdashboard not ready, attempt', attempt, 'of', maxAttempts);
      setTimeout(() => waitForFlexdashboard(callback, maxAttempts, attempt + 1), 200);
    } else {
      console.log('Flexdashboard navigation not found after', maxAttempts, 'attempts');
      // Try anyway as fallback
      callback();
    }
  }
  
  // Wait for flexdashboard to be fully loaded, then restore page
  waitForFlexdashboard(restoreLastPage);
  
  // Track hash changes to save current page
  $(window).on('hashchange', function() {
    saveCurrentPage();
  });
  
  // Also track clicks on navigation links
  $(document).on('click', '.navbar-nav a[href^="#"]', function() {
    setTimeout(saveCurrentPage, 100); // Small delay to ensure hash is updated
  });
  
  // Save initial page after everything is loaded
  setTimeout(saveCurrentPage, 2000);
});
```
