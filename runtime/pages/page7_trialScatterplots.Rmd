### Options
```{r,echo=FALSE}
# Initial placeholder choices - will be updated dynamically
selectizeInput("muxscatter", "xscatter",
  choices = NULL, selected = NULL, multiple = FALSE
)
selectizeInput("muyscatter", "yscatter",
  choices = NULL, selected = NULL, multiple = FALSE
)

selectizeInput("groupScatterTrial", "Group by",
  choices = NULL, selected = NULL, multiple = FALSE
)

checkboxInput("averageData_trial", "Average data across condition", value = FALSE)
checkboxInput("diffData_trial", "Calculate difference + means per participant", value = FALSE)
```

Column
--------------------------------------------

### Scatterplot TrialData {data-height=1500}
Create scatterplots of the aggregated results of the selected data (1 datapoint per foot per trial per participant).

```{r}
imageOutput("scatter_mu")
```

```{r, context="server"}
# Function to get and possibly summarize the data
get_scatter_data <- reactive({
  data <- get_mu_dyn_long()
  if (input$averageData_trial) {
    data <- summarize_across_conditions(data)
  }
  return(data)
})

# Create dynamic observers for variable selection
create_dynamic_variable_observer(
  data_reactive = get_scatter_data,
  input_id = "muxscatter",
  column_filter = is.numeric,
  exclude_patterns = c("heelStrikes\\.", "toeOffs\\."),
  default_choice = "task_max_q",
  fallback_choices = c("stepWidths.sd", "stepLengths.sd"),
  multiple = FALSE,
  input = input
)

create_dynamic_variable_observer(
  data_reactive = get_scatter_data,
  input_id = "muyscatter",
  column_filter = is.numeric,
  exclude_patterns = c("heelStrikes\\.", "toeOffs\\."),
  default_choice = "task_max_e",
  fallback_choices = c("stepLengths.sd", "stepWidths.sd"),
  multiple = FALSE,
  input = input
)

# Create dynamic observer for category selection
create_dynamic_category_observer(
  data_reactive = get_scatter_data,
  input_id = "groupScatterTrial",
  category_choices = categoriesExtraInputs,
  default_selection = "participant",
  multiple = FALSE,
  input = input
)

output$scatter_mu <- renderSVG({ reactive({
  make_scatter_plot_steps(get_scatter_data(), input$groupScatterTrial, input$muxscatter, input$muyscatter, show_legend=TRUE, baseSize = input$baseSize)
  })
})
