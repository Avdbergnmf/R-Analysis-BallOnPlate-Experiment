#### Participant Filtering
```{r}
selectizeInput("filterParticipants", "Participants", choices = participants, selected = participants, multiple = TRUE)
div(style = "margin-top: 5px;",
  actionButton("selectAllParticipants", "all", class = "btn-xs btn-success", style = "padding:2px 6px; font-size:10px; line-height:1.2;"),
  actionButton("clearAllParticipants", "clear", class = "btn-xs btn-danger", style = "margin-left: 6px; padding:2px 6px; font-size:10px; line-height:1.2;")
)
```

```{r, context="server"}
observeEvent(input$selectAllParticipants, {
  updateSelectizeInput(session, "filterParticipants", selected = participants)
}, ignoreInit = TRUE)

observeEvent(input$clearAllParticipants, {
  updateSelectizeInput(session, "filterParticipants", selected = character(0))
}, ignoreInit = TRUE)
```

#### Trial Filtering
```{r}
defaultTrials <- c(5,10,11)
selectizeInput("filterTrials", "Trials", choices = allTrials, selected = defaultTrials, multiple = TRUE)
div(style = "margin-top: 5px;",
  actionButton("selectAllTrials", "all", class = "btn-xs btn-success", style = "padding:2px 6px; font-size:10px; line-height:1.2;"),
  actionButton("selectDefaultTrials", "default", class = "btn-xs btn-info", style = "margin-left: 6px; padding:2px 6px; font-size:10px; line-height:1.2;"),
  actionButton("clearAllTrials", "clear", class = "btn-xs btn-danger", style = "margin-left: 6px; padding:2px 6px; font-size:10px; line-height:1.2;")
)
selectizeInput("filterCondition", "Condition", choices = c("control", "perturbation", "perturbation_visualization"), selected = c("control", "perturbation", "perturbation_visualization"), multiple = TRUE)
phaseChoices <- unique(unlist(default_phases))
selectizeInput("filterPhase", "Phase", choices = phaseChoices, selected = phaseChoices, multiple = TRUE)
```

```{r, context="server"}
observeEvent(input$selectAllTrials, {
  updateSelectizeInput(session, "filterTrials", selected = allTrials)
}, ignoreInit = TRUE)

observeEvent(input$clearAllTrials, {
  updateSelectizeInput(session, "filterTrials", selected = character(0))
}, ignoreInit = TRUE)

observeEvent(input$selectDefaultTrials, {
  updateSelectizeInput(session, "filterTrials", selected = c(5, 10, 11))
}, ignoreInit = TRUE)
 
#### Derived Metrics (global)
```{r}
actionButton("open_global_derived_modal", "Derived Metrics", class = "btn btn-sm btn-primary")
```

#### Server logic for global derived metrics
```{r, context="server"}
# Persistent storage for global derived metric definitions
# Load from saved file if available
derived_metrics_file <- "data_extra/derived_metrics.csv"
load_derived_metrics <- function() {
  if (file.exists(derived_metrics_file)) {
    tryCatch({
      defs <- read.csv(derived_metrics_file, stringsAsFactors = FALSE)
      if (nrow(defs) > 0 && all(c("var", "scope", "level", "label", "colname") %in% names(defs))) {
        return(defs)
      }
    }, error = function(e) {
      warning("Failed to load derived metrics: ", e$message)
    })
  }
  return(data.frame(
    var = character(0),
    scope = character(0),
    level = character(0),
    label = character(0),
    colname = character(0),
    stringsAsFactors = FALSE
  ))
}

save_derived_metrics <- function(defs) {
  tryCatch({
    write.csv(defs, derived_metrics_file, row.names = FALSE)
  }, error = function(e) {
    warning("Failed to save derived metrics: ", e$message)
  })
}

global_derived_metric_defs <- reactiveVal(load_derived_metrics())

observeEvent(input$open_global_derived_modal, {
  # Get numeric columns from global cache (updated by get_mu_dyn_long)
  numeric_choices <- if (exists("mu_numeric_choices")) mu_numeric_choices else character(0)
  
  showModal(modalDialog(
    title = "Derived Metrics (Global)",
    size = "m",
    easyClose = TRUE,
    footer = tagList(modalButton("Close")),
    tags$div(
      selectizeInput("global_derived_var", "Base metric (from current data)",
        choices = numeric_choices, selected = NULL, multiple = FALSE
      ),
      radioButtons("global_derived_scope", "Use level from",
        choices = c("Phase" = "phase", "Trial Number" = "trial"),
        selected = "phase", inline = TRUE
      ),
      uiOutput("global_derived_level_ui"),
      actionButton("global_derived_add", "Add derived metric", class = "btn btn-primary btn-sm"),
      tags$hr(),
      uiOutput("global_derived_metric_defs_ui")
    )
  ))
})

output$global_derived_level_ui <- renderUI({
  scope <- input$global_derived_scope %||% "phase"
  if (identical(scope, "phase")) {
    ensure_global_data_initialized()
    lvls <- if (exists("allPhases")) allPhases else character(0)
  } else {
    ensure_global_data_initialized()
    lvls <- if (exists("allTrials")) sort(allTrials) else numeric(0)
  }
  selectizeInput("global_derived_level", "Level (from full dataset)",
    choices = lvls, selected = if (length(lvls) > 0) lvls[[1]] else NULL, multiple = FALSE
  )
})

observeEvent(input$global_derived_add, {
  var <- input$global_derived_var
  scope <- input$global_derived_scope
  level <- input$global_derived_level
  if (is.null(var) || !nzchar(var)) {
    showNotification("Select a base metric first.", type = "error")
    return()
  }
  if (is.null(scope) || is.null(level) || !nzchar(as.character(level))) {
    showNotification("Select a phase/trial level.", type = "error")
    return()
  }
  scope_key <- if (identical(scope, "trial")) "trial" else "phase"
  level_str <- as.character(level)
  # Build column name with underscores (safe for R formulas)
  var_safe <- gsub("\\.", "_", var)
  colname <- sprintf("%s_%s_%s", var_safe, scope_key, level_str)
  label <- sprintf("%s at %s = %s", var, scope_key, level_str)
  defs <- global_derived_metric_defs()
  if (nrow(defs) > 0 && any(defs$colname == colname)) {
    showNotification("Metric already added.", type = "message")
    return()
  }
  new_row <- data.frame(var = var, scope = scope_key, level = level_str, label = label, colname = colname, stringsAsFactors = FALSE)
  new_defs <- rbind(defs, new_row)
  global_derived_metric_defs(new_defs)
  save_derived_metrics(new_defs)
})

observeEvent(input$global_remove_derived_id, {
  id <- input$global_remove_derived_id
  defs <- global_derived_metric_defs()
  if (!is.null(defs) && nrow(defs) > 0) {
    keep <- defs$colname != id
    new_defs <- defs[keep, , drop = FALSE]
    global_derived_metric_defs(new_defs)
    save_derived_metrics(new_defs)
  }
}, ignoreInit = TRUE)

output$global_derived_metric_defs_ui <- renderUI({
  defs <- global_derived_metric_defs()
  if (is.null(defs) || nrow(defs) == 0) return(tags$em("No derived metrics defined yet."))
  tags$div(
    tags$strong("Current derived metrics:"),
    tags$ul(lapply(seq_len(nrow(defs)), function(i) {
      id <- defs$colname[i]
      tags$li(
        sprintf("%s", id),
        HTML(sprintf(
          "&nbsp;<button type='button' class='btn btn-xs btn-danger' onclick=\"Shiny.setInputValue('global_remove_derived_id','%s',{priority:'event'})\">remove</button>",
          id
        ))
      )
    }))
  )
})
```

#### Step Filtering
Note: slicing doesn't work completely atm. But left the old code in because I will probably need it later.
```{r}
selectizeInput("filterOutliers", "Outliers", choices = c(TRUE, FALSE), selected = c(FALSE), multiple = TRUE) # INCLUDE outliers (TRUE), INCLUDE non-outliers (FALSE)
selectizeInput("filterSuspect", "Suspect Steps", choices = c(TRUE, FALSE), selected = c(TRUE, FALSE), multiple = TRUE) # INCLUDE suspect steps (TRUE), INCLUDE non-suspect steps (FALSE)

checkboxInput("do_slicing", "Slice data", value = FALSE)
numericInput("slice_length", "Slice data (seconds)",  min = 0, max = 180, value = 9999, step = 10)
checkboxInput("remove_middle_slices", "Only keep first and last slice", value=FALSE)
```

#### Left vs Right Steps
Note: you can also average across feet here, this takes the result of both feet of 1 participant in 1 trial and averages their values to create 1 value per trial per participant for the aggregated data (this step is done last, after calculating the results of the individual feet).
```{r}
selectizeInput("filterSide", "Side", choices = c("Left", "Right"), selected = c("Left", "Right"), multiple = TRUE)
checkboxInput("avg_feet", "Average across feet", value = TRUE)
checkboxInput("add_diff", "add diffFeet columns",value = FALSE)
bsTooltip("add_diff", 
          "Calculate difference of calculated metrics (mean, sd, cv) between left and right foot and add to summary table.", 
          placement = "right", 
          trigger = "hover")
```

#### Figure Options
```{r}
numericInput("plotheight", "Plot Height (pixels)",
  min = 50, max = Inf, value = 500, step = 50)
numericInput("plotwidth", "Plot Width (pixels)",
  min = 50, max = Inf, value = 1000, step = 50)

numericInput("baseSize", "Base Size",
  min = 1, max = Inf, value = 10, step = 1)
```

#### Universal Data Filtering Function
```{r, context="server"}
# Universal filter function that can be used by any caching system
get_universal_filters <- function() {
  filter_logger <- create_module_logger("UNIVERSAL-FILTER")
  
  filter_logger("DEBUG", "get_universal_filters() called")
  
  # Check if required inputs exist
  if (any(is.null(input$filterParticipants), is.null(input$filterTrials))) {
    filter_logger("WARN", "Missing required inputs - participants or trials is NULL")
    filter_logger("DEBUG", "filterParticipants:", if(is.null(input$filterParticipants)) "NULL" else paste(input$filterParticipants, collapse = ", "))
    filter_logger("DEBUG", "filterTrials:", if(is.null(input$filterTrials)) "NULL" else paste(input$filterTrials, collapse = ", "))
    return(NULL)
  }
  
  filter_logger("DEBUG", "Raw participants:", paste(input$filterParticipants, collapse = ", "))
  filter_logger("DEBUG", "Raw trials:", paste(input$filterTrials, collapse = ", "))
  filter_logger("DEBUG", "Raw conditions:", if(is.null(input$filterCondition)) "NULL" else paste(input$filterCondition, collapse = ", "))
  
  # Pre-filter participants by condition if specified
  filtered_participants <- input$filterParticipants
  if (!is.null(input$filterCondition) && length(input$filterCondition) > 0) {
    filter_logger("DEBUG", "Filtering participants by conditions:", paste(input$filterCondition, collapse = ", "))
    # Get participants that match any of the selected conditions
    condition_participants <- c()
    for (participant in input$filterParticipants) {
      participant_condition <- condition_number(participant)
      if (participant_condition %in% input$filterCondition) {
        condition_participants <- c(condition_participants, participant)
      }
    }
    filtered_participants <- condition_participants
    filter_logger("DEBUG", "After condition filtering:", length(filtered_participants), "participants")
  } else {
    filter_logger("DEBUG", "No condition filtering applied")
  }
  
  # Return universal filter state
  result <- list(
    participants = filtered_participants,
    trials = input$filterTrials,
    condition = input$filterCondition
  )
  
  filter_logger("DEBUG", "Returning filters:", length(result$participants), "participants,", length(result$trials), "trials,", 
                if(is.null(result$condition)) 0 else length(result$condition), "conditions")
  filter_logger("DEBUG", "Final participants:", paste(result$participants, collapse = ", "))
  filter_logger("DEBUG", "Final trials:", paste(result$trials, collapse = ", "))
  
  return(result)
}
```