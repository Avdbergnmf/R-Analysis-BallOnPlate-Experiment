### Options

```{r}
selectizeInput("plotVar", "Variable", choices = NULL, selected = NULL, multiple = FALSE)
selectizeInput("plotVarTransform", "Transform variable",
  choices = c("None" = "none", "Log10" = "log10", "Logit" = "logit"),
  selected = "none", multiple = FALSE
)
# selectizeInput("plotMetric", "Metric", choices = varMetrics, selected = varMetrics[1], multiple = FALSE)
selectizeInput("varCategory", "Category", choices = NULL, selected = NULL, multiple = TRUE)
selectizeInput("colorCategory", "Color", choices = NULL, selected = NULL, multiple = FALSE)
selectizeInput("shapeCategory", "Shape", choices = NULL, selected = NULL, multiple = FALSE)
checkboxInput("doPaired", "Make it a paired plot", value = FALSE)
selectizeInput("pairedCategory", "Paired Category", choices = NULL, selected = NULL, multiple = FALSE)
checkboxInput("useSVG", "Make SVG for saving", value = FALSE)
```

```{r}
bsTooltip("plotVarTransform",
  "Apply transformation to the plotted variable. Log10 transformation can help with skewed data. Logit transformation is for proportions (values between 0 and 1).",
  placement = "right",
  trigger = "hover"
)
```

Column
--------------------------------------------

### Step Variability Plot  {data-height=2500}
Generate boxplots of the selected data that are split up according to different categories.
```{r}
uiOutput("plotOutput")
```

```{r, context="server"}
# Create dynamic observers for variable selection
create_dynamic_variable_observer(
  data_reactive = get_mu_dyn_long,
  input_id = "plotVar",
  column_filter = function(x) TRUE, # All columns
  exclude_patterns = NULL,
  default_choice = "stepWidths.sd",
  fallback_choices = c("task_max_q", "stepLengths.sd"),
  multiple = FALSE,
  input = input
)

# Create dynamic observers for category selection
create_dynamic_category_observer(
  data_reactive = get_mu_dyn_long,
  input_id = "varCategory",
  category_choices = categoriesExtraInputs,
  default_selection = c("trialNum", "condition"),
  multiple = TRUE,
  input = input
)

create_dynamic_category_observer(
  data_reactive = get_mu_dyn_long,
  input_id = "colorCategory",
  category_choices = categoriesExtraInputs,
  default_selection = "participant",
  multiple = FALSE,
  input = input
)

create_dynamic_category_observer(
  data_reactive = get_mu_dyn_long,
  input_id = "shapeCategory",
  category_choices = c("None", categoriesExtraInputs),
  default_selection = "None",
  multiple = FALSE,
  input = input
)

create_dynamic_category_observer(
  data_reactive = get_mu_dyn_long,
  input_id = "pairedCategory",
  category_choices = c("None", categoriesExtraInputs),
  default_selection = "None",
  multiple = FALSE,
  input = input
)

# Shared function to generate the plot
generate_boxplot <- function() {
  tryCatch({
    mu <- get_mu_dyn_long()
    
    # Validate data and inputs
    if (is.null(mu) || !is.data.frame(mu) || nrow(mu) == 0) {
      stop("No data available for plotting")
    }
    
    if (is.null(input$plotVar) || input$plotVar == "" || 
        !input$plotVar %in% colnames(mu)) {
      stop("Invalid or missing plot variable")
    }
    
    # Apply transformation to the plotting variable if selected
    mu <- stats$transform_dependent_variable(mu, input$plotVar, input$plotVarTransform)
    if (is.null(mu)) {
      stop("Transformation failed. Check notification for details.")
    }
    
    # Validate categories exist in data
    available_cols <- colnames(mu)
    if (!is.null(input$varCategory) && length(input$varCategory) > 0) {
      invalid_cats <- input$varCategory[!input$varCategory %in% c(available_cols, "None")]
      if (length(invalid_cats) > 0) {
        warning("Invalid category variables: ", paste(invalid_cats, collapse = ", "))
      }
    }
    
    # Generate the plot with the (potentially transformed) data
    if (!input$doPaired) {
      plot_boxplots(mu, input$plotVar, input$varCategory, input$colorCategory, input$shapeCategory, input$baseSize)
    } else {
      if (is.null(input$pairedCategory) || input$pairedCategory == "None" || 
          !input$pairedCategory %in% available_cols) {
        warning("Invalid paired category, switching to regular boxplot")
        plot_boxplots(mu, input$plotVar, input$varCategory, input$colorCategory, input$shapeCategory, input$baseSize)
      } else {
        plot_paired(mu, input$plotVar, input$pairedCategory, input$varCategory, input$colorCategory, input$shapeCategory, input$baseSize)
      }
    }
  }, error = function(e) {
    # Return a simple error plot instead of crashing
    warning("Error generating boxplot: ", e$message)
    
    # Create a simple error message plot
    ggplot() + 
      annotate("text", x = 0.5, y = 0.5, 
              label = paste("Error generating plot:\n", e$message), 
              hjust = 0.5, vjust = 0.5, size = 4, color = "red") +
      xlim(0, 1) + ylim(0, 1) +
      theme_void() +
      ggtitle("Plot Generation Error")
  })
}

# Create a reactive plot generator
plot_reactive <- reactive({
  generate_boxplot()
})

# Render the plot based on SVG setting
output$plotOutput <- renderUI({
  if (input$useSVG) {
    renderSVG(plot_reactive)
  } else {
    renderPlotly({
      p <- plot_reactive()
      # Convert to plotly with hover text
      ggplotly(p, tooltip = "text", width = input$plotwidth, height = input$plotheight, source = "boxplot_page") %>%
        layout(dragmode = "pan") %>%
        event_register("plotly_click")
    })
  }
})
