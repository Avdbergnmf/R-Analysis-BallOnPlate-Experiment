
### Plot Options
```{r}
# Create page-specific logger (logging system already loaded globally)
page_logger <- create_module_logger("PAGE3-RAW-TRACKER")
page_logger("DEBUG", "Initializing raw tracker data page options")

checkboxInput("plotlines", "plot lines", value = TRUE)
checkboxInput("plotpoints", "plot points", value = FALSE)

selectizeInput("tracker", "Data to plot",
  choices = trackers, selected = trackers[2], multiple = FALSE
)

selectizeInput("participant2d", "participant",
  choices = participants, selected = participants[1], multiple = FALSE
)
selectizeInput("trialNum2d", "Trial Number",
  choices = allTrials, selected = allTrials[2], multiple = FALSE
)


selectizeInput("xplot2d", "xplot",
  choices = xOptions2D, selected = xOptions2D[2], multiple = FALSE
)
selectizeInput("yplot2d", "yplot",
  choices = xOptions2D, selected = xOptions2D[3], multiple = FALSE
)
```


Column
--------------------------------------------
### 2D plot {data-height=1500}
Simple interface to create some 2D plots of the raw tracker data for debugging purposes.
```{r}
# imageOutput("TwoD")
plotlyOutput("TwoD_interactive")
```

```{r, context="server"}
# Use the page logger already created in the options section

# Helper function to update plot options while preserving selection
updatePlotOptions <- function(tracker, target_x, target_y, current_x = NULL, current_y = NULL) {
  page_logger("DEBUG", "Updating plot options for tracker:", tracker)
  trialNum <- if (is.null(input$trialNum2d)) allTrials[2] else as.numeric(input$trialNum2d)
  choices <- get_tracker_options(tracker, trialNum)

  # Preserve previous selections if they still exist
  selected_x <- if (!is.null(current_x) && current_x %in% choices) current_x else choices[min(2, length(choices))]
  selected_y <- if (!is.null(current_y) && current_y %in% choices) current_y else choices[min(3, length(choices))]

  updateSelectizeInput(session = getDefaultReactiveDomain(), target_x, choices = choices, selected = selected_x)
  updateSelectizeInput(session = getDefaultReactiveDomain(), target_y, choices = choices, selected = selected_y)
}

# Update plot options when any relevant input changes
observeEvent(
  {
    list(input$tracker, input$trialNum2d)
  },
  {
    if (!is.null(input$tracker)) {
      updatePlotOptions(
        input$tracker,
        "xplot2d", "yplot2d",
        input$xplot2d, input$yplot2d
      )
    }
  }
)

output$TwoD <- renderSVG({
  reactive({
    page_logger("DEBUG", "Rendering static 2D plot for participant:", input$participant2d, "trial:", input$trialNum2d, "tracker:", input$tracker)

    # Load data for both trackers
    xData <- get_t_data(input$participant2d, input$tracker, as.numeric(input$trialNum2d))
    yData <- get_t_data(input$participant2d, input$tracker, as.numeric(input$trialNum2d))

    plotting$plot_2d(xData, yData, input$tracker, input$tracker, input$participant2d, as.numeric(input$trialNum2d), input$xplot2d, input$yplot2d, input$plotlines, input$plotpoints, baseSize = input$baseSize)
  })
})


output$TwoD_interactive <- renderPlotly({
  page_logger("DEBUG", "Rendering interactive 2D plot for participant:", input$participant2d, "trial:", input$trialNum2d, "tracker:", input$tracker)

  # Load data for both trackers
  xData <- get_t_data(input$participant2d, input$tracker, as.numeric(input$trialNum2d))
  yData <- get_t_data(input$participant2d, input$tracker, as.numeric(input$trialNum2d))

  p <- plotting$plot_2d(
    xData, yData, input$tracker, input$tracker,
    input$participant2d,
    as.numeric(input$trialNum2d),
    input$xplot2d, input$yplot2d,
    input$plotlines, input$plotpoints,
    baseSize = input$baseSize
  )

  # Convert to ggplotly
  ggplotly(p, width = input$plotwidth, height = input$plotheight) %>% layout(autosize = F)
})
```
