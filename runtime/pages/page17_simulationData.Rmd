### Plot Options
```{r}
# Participant and trial selection
selectizeInput("sim_participant", "Participant",
  choices = participants, selected = participants[1], multiple = FALSE
)
selectizeInput("sim_trialNum", "Trial Number",
  choices = allTrials, selected = allTrials[3], multiple = FALSE
)


# Variable selection for time series
selectizeInput("sim_vars", "Time-series variables",
  choices = NULL, multiple = TRUE
)

# Downsampling
numericInput("sim_downsampling", "Downsample factor",
  value = 1, min = 1, step = 1
)

# Risk predictions toggle
checkboxInput("enable_risk_predictions", "Enable Risk Predictions",
  value = TRUE, width = "100%"
)

# Direct model prediction toggle (for dashboard testing)
checkboxInput("allow_direct_model", "Allow Direct Model Prediction",
  value = FALSE, width = "100%"
)

# Tau parameter for risk predictions
numericInput("risk_tau", "Risk Prediction Time Horizon (seconds)",
  value = 0.15, min = 0, max = 5, step = 0.1, width = "100%"
)

# Sampling frequency for model training
numericInput("sampling_freq", "Sampling Frequency for Training (Hz)",
  value = 90, min = 1, max = 200, step = 1, width = "100%"
)

# Standardized training toggle
checkboxInput("enable_standardized_training", "Enable Standardized Training",
  value = FALSE, width = "100%"
)

# Standardized condition and phase selection (only shown when standardized training is enabled)
conditionalPanel(
  condition = "input.enable_standardized_training == true",
  selectizeInput("standardized_condition", "Standardized Condition",
    choices = NULL, selected = NULL, multiple = FALSE
  ),
  selectizeInput("standardized_phase", "Standardized Phase",
    choices = NULL, selected = NULL, multiple = FALSE
  )
)

# Risk model management
selectizeInput("risk_model_file", "Risk Model File",
  choices = NULL, selected = NULL, multiple = FALSE
)
actionButton("load_risk_model", "Load Selected Model",
  class = "btn-success", style = "margin-top: 5px;"
)
actionButton("train_risk_model", "Train New Model",
  class = "btn-primary", style = "margin-top: 5px;"
)
div(class = "text-muted", style = "margin-top: 5px;", uiOutput("current_model_info"))

# Hazard samples management
selectizeInput("hazard_samples_file", "Hazard Samples File",
  choices = NULL, selected = NULL, multiple = FALSE
)
actionButton("predict_hazard_samples", "Predict",
  class = "btn-info", style = "margin-top: 5px;"
)

actionButton("perform_risk_analysis", "Perform Risk Analysis",
  class = "btn-success", style = "margin-top: 5px;"
)
```

Column
--------------------------------------------

### Simulation Data Availability
```{r}
textOutput("sim_data_status")
```

### Time Series Plot {data-height=600}
Shows selected variables over time.
```{r}
plotlyOutput("sim_tsPlot")
```

```{r, context="server"}
risk_analysis_state <- reactiveValues(
  pending = NULL,
  latest_model_path = NULL,
  latest_hazard_path = NULL,
  model_modal_shown = FALSE
)

showRiskModal <- function(title, body, footer = modalButton("Close"), size = "m", easyClose = TRUE) {
  showModal(modalDialog(
    title = title,
    body,
    easyClose = easyClose,
    size = size,
    footer = footer
  ))
}

showRiskSuccessModal <- function(title, message, details = NULL, footer = modalButton("Close"), size = "m", easyClose = TRUE) {
  showRiskModal(
    title = title,
    body = tagList(
      tags$p(message),
      if (!is.null(details)) tags$pre(details)
    ),
    footer = footer,
    size = size,
    easyClose = easyClose
  )
}

showRiskErrorModal <- function(title, message, details = NULL, size = "l") {
  showRiskModal(
    title = title,
    body = tagList(
      tags$p(message),
      if (!is.null(details)) tags$pre(details)
    ),
    footer = modalButton("Close"),
    size = size,
    easyClose = TRUE
  )
}

formatOperationDetails <- function(context, extras = NULL, error = NULL) {
  parts <- c(
    paste0("Context: ", context),
    paste0("Timestamp: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S"))
  )
  if (!is.null(extras)) {
    parts <- c(parts, extras)
  }
  if (!is.null(error)) {
    parts <- c(parts, paste0("Error message: ", conditionMessage(error)))
    call <- conditionCall(error)
    if (!is.null(call)) {
      parts <- c(parts, paste0("Call: ", deparse(call)))
    }
  }
  paste(parts, collapse = "\n")
}

load_risk_model_internal <- function(model_file, notify = TRUE, from_modal = FALSE) {
  if (is.null(model_file) || identical(model_file, "No risk model files found")) {
    if (notify) {
      showRiskErrorModal(
        title = "Load Risk Model",
        message = "Select a valid risk model file before loading."
      )
    }
    return(FALSE)
  }

  if (!exists("simulation", envir = .GlobalEnv)) {
    if (notify) {
      showRiskErrorModal(
        title = "Load Risk Model",
        message = "The simulation module is not available; cannot load the model."
      )
    }
    return(FALSE)
  }

  model_path <- file.path(dataExtraFolder, model_file)

  tryCatch(
    {
      model <- simulation$load_risk_model(model_path)

      if (is.null(model)) {
        if (notify) {
          showRiskErrorModal(
            title = "Load Risk Model Failed",
            message = "The selected risk model could not be loaded.",
            details = formatOperationDetails(
              context = "Load risk model failure",
              extras = paste0("Path: ", model_path)
            )
          )
        }
        return(FALSE)
      }

      GLOBAL_RISK_MODEL <<- model
      risk_analysis_state$latest_model_path <- model_path
      risk_analysis_state$model_modal_shown <- FALSE

        if (notify) {
          showRiskSuccessModal(
            title = "Risk Model Loaded",
            message = sprintf("Loaded %s (%s).", model_file, class(model)[1]),
            details = formatOperationDetails(
              context = "Risk model loaded",
              extras = c(
                paste0("Path: ", model_path),
                paste0("Class: ", class(model)[1])
              )
            )
          )
        }
        risk_analysis_state$model_modal_shown <- FALSE
        return(TRUE)
    },
    error = function(e) {
      if (notify) {
        showRiskErrorModal(
          title = "Load Risk Model Failed",
          message = "The selected risk model could not be loaded.",
          details = formatOperationDetails(
            context = "Load risk model failure",
            extras = paste0("Path: ", model_path),
            error = e
          )
        )
      }
      return(FALSE)
    }
  )
}

runRiskAnalysis <- function(model_path, hazard_samples_path) {
  progress <- shiny::Progress$new(session = shiny::getDefaultReactiveDomain())
  progress$set(message = "Running risk analysis", detail = "Loading risk model", value = 0.05)
  progress_closed <- FALSE
  on.exit(
    {
      if (!progress_closed) {
        progress$close()
      }
    },
    add = TRUE
  )

  tryCatch(
    {
      model <- simulation$load_risk_model(model_path)
      if (is.null(model)) {
        stop(sprintf("Risk model could not be loaded from %s", model_path), call. = FALSE)
      }

      progress$set(detail = "Loading hazard samples", value = 0.25)
      hazard_samples <- readRDS(hazard_samples_path)
      if (is.null(hazard_samples) || nrow(hazard_samples) == 0) {
        stop(sprintf("Hazard samples are missing or empty at %s", hazard_samples_path), call. = FALSE)
      }

      progress$set(detail = "Computing standardized risks", value = 0.7)
      results <- simulation$compute_pooled_standardized_risks(
        model = model,
        hazard_samples = hazard_samples
      )

      progress$set(detail = "Preparing results", value = 0.9)

      n_combinations <- nrow(results$standardized_risks)
      n_participants <- length(unique(hazard_samples$participant))
      n_samples <- nrow(hazard_samples)

      risk_analysis_state$latest_model_path <- model_path
      risk_analysis_state$latest_hazard_path <- hazard_samples_path

      summary_table <- data.frame(
        Item = c("Risk model", "Hazard samples", "Combinations analysed", "Total samples", "Participants"),
        Value = c(basename(model_path), basename(hazard_samples_path), n_combinations, n_samples, n_participants),
        stringsAsFactors = FALSE
      )
      summary_table$Value <- as.character(summary_table$Value)

      std_table <- results$standardized_risks
      if (!is.null(std_table) && nrow(std_table) > 0) {
        std_table <- std_table |>
          dplyr::arrange(condition, phase) |>
          dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 6)))
      } else {
        std_table <- data.frame(Message = "No standardized risk rows available")
      }

      within_table <- results$analysis_results$within_condition_CI
      if (!is.null(within_table) && nrow(within_table) > 0) {
        within_table <- within_table |>
          dplyr::select(dplyr::any_of(c("condition", "delta", "point", "lo", "hi", "p_boot", "p_boot_holm"))) |>
          dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 6)))
      } else {
        within_table <- data.frame(Message = "No within-condition bootstrap results available")
      }

      did_table <- results$analysis_results$bootstrap_DiD_CI
      if (!is.null(did_table) && nrow(did_table) > 0) {
        did_table <- did_table |>
          dplyr::select(dplyr::any_of(c("contrast", "point", "lo", "hi", "p_boot", "p_boot_holm"))) |>
          dplyr::mutate(dplyr::across(dplyr::where(is.numeric), ~ round(.x, 6)))
      } else {
        did_table <- data.frame(Message = "No difference-in-differences results available for the current dataset")
      }

      interaction_info <- NULL
      wald_test <- results$analysis_results$wald_interaction
      if (!is.null(wald_test) && !is.null(wald_test$p.value)) {
        interaction_info <- sprintf("Wald p = %.4f", wald_test$p.value)
      }
      if (!is.null(interaction_info)) {
        summary_table <- rbind(summary_table, data.frame(Item = "Condition x Phase interaction", Value = interaction_info, stringsAsFactors = FALSE))
      }

      output$risk_analysis_summary_table <- renderTable(
        {
          summary_table
        },
        rownames = FALSE,
        align = "ll"
      )

      output$risk_analysis_std_table <- renderTable(
        {
          std_table
        },
        rownames = FALSE,
        digits = 6
      )

      output$risk_analysis_within_table <- renderTable(
        {
          within_table
        },
        rownames = FALSE,
        digits = 6
      )

      output$risk_analysis_did_table <- renderTable(
        {
          did_table
        },
        rownames = FALSE,
        digits = 6
      )

      output$risk_analysis_plot <- renderPlot({
        if (!is.null(results$analysis_results$plot)) {
          results$analysis_results$plot
        } else {
          ggplot2::ggplot() +
            ggplot2::theme_void() +
            ggplot2::labs(title = "No bootstrap diagnostics available")
        }
      })

      progress$set(detail = "Completed", value = 1)
      progress$close()
      progress_closed <- TRUE

      showRiskModal(
        title = "Risk Analysis Complete",
        body = tagList(
          tags$p("Risk analysis finished successfully. Results have been saved and are available for review."),
          tags$h4("Summary"),
          tableOutput("risk_analysis_summary_table"),
          tags$h4("Standardized Risks"),
          tableOutput("risk_analysis_std_table"),
          tags$h4("Within-Condition Changes"),
          tableOutput("risk_analysis_within_table"),
          tags$h4("Difference-in-Differences"),
          tableOutput("risk_analysis_did_table"),
          tags$h4("Bootstrap Diagnostics"),
          plotOutput("risk_analysis_plot", height = "400px")
        ),
        footer = modalButton("Close"),
        size = "l",
        easyClose = TRUE
      )
      TRUE
    },
    error = function(e) {
      if (!progress_closed) {
        progress$close()
        progress_closed <- TRUE
      }
      showRiskErrorModal(
        title = "Risk Analysis Failed",
        message = "Risk analysis could not be completed.",
        details = formatOperationDetails(
          context = "Risk analysis failure",
          extras = c(
            paste0("Risk model: ", basename(model_path)),
            paste0("Hazard samples: ", basename(hazard_samples_path))
          ),
          error = e
        )
      )
      FALSE
    }
  )
}

performHazardPrediction <- function(model_file, hazard_file) {
  if (is.null(model_file) || identical(model_file, "No risk model files found")) {
    showRiskErrorModal(
      title = "Generate Predictions",
      message = "Select a valid risk model file before generating predictions."
    )
    return(FALSE)
  }

  if (is.null(hazard_file) || identical(hazard_file, "No hazard samples files found")) {
    showRiskErrorModal(
      title = "Generate Predictions",
      message = "Select a valid hazard samples file before generating predictions."
    )
    return(FALSE)
  }

  model_path <- file.path(dataExtraFolder, model_file)
  hazard_samples_path <- file.path(dataExtraFolder, hazard_file)

  if (!file.exists(model_path)) {
    showRiskErrorModal(
      title = "Generate Predictions",
      message = "The selected risk model file could not be found on disk.",
      details = formatOperationDetails(
        context = "Hazard prediction validation",
        extras = paste0("Missing model path: ", model_path)
      )
    )
    return(FALSE)
  }

  if (!file.exists(hazard_samples_path)) {
    showRiskErrorModal(
      title = "Generate Predictions",
      message = "The selected hazard samples file could not be found on disk.",
      details = formatOperationDetails(
        context = "Hazard prediction validation",
        extras = paste0("Missing hazard samples path: ", hazard_samples_path)
      )
    )
    return(FALSE)
  }

  tryCatch(
    {
      prediction <- withProgress(message = "Generating hazard predictions", value = 0, {
        incProgress(0.2, detail = "Loading risk model")
        model <- simulation$load_risk_model(model_path)
        if (is.null(model)) {
          stop(sprintf("Risk model could not be loaded from %s", model_path), call. = FALSE)
        }

        incProgress(0.4, detail = "Loading hazard samples")
        hazard_samples <- readRDS(hazard_samples_path)
        if (is.null(hazard_samples) || nrow(hazard_samples) == 0) {
          stop(sprintf("Hazard samples are missing or empty at %s", hazard_samples_path), call. = FALSE)
        }

        incProgress(0.75, detail = "Applying risk model to hazard samples")
        hazard_samples <- simulation$annotate_hazard_predictions(
          model = model,
          hazard_samples = hazard_samples,
          include_re = FALSE,
          out_path = risk_hazard_samples_preds_path
        )

        list(hazard_samples = hazard_samples)
      })

      hazard_samples <- prediction$hazard_samples
      n_participants <- length(unique(hazard_samples$participant))
      n_samples <- nrow(hazard_samples)

      risk_analysis_state$latest_model_path <- model_path
      if (file.exists(risk_hazard_samples_preds_path)) {
        risk_analysis_state$latest_hazard_path <- risk_hazard_samples_preds_path
        updateSelectizeInput(session, "hazard_samples_file",
          selected = basename(risk_hazard_samples_preds_path)
        )
      } else {
        risk_analysis_state$latest_hazard_path <- hazard_samples_path
      }
      risk_analysis_state$pending <- NULL

      predicted_file <- if (file.exists(risk_hazard_samples_preds_path)) {
        basename(risk_hazard_samples_preds_path)
      } else {
        "<not saved>"
      }

      detail_text <- formatOperationDetails(
        context = "Hazard predictions generated",
        extras = c(
          paste0("Risk model: ", basename(model_path)),
          paste0("Source hazard samples: ", basename(hazard_samples_path)),
          paste0("Predicted samples file: ", predicted_file),
          paste0("Participants: ", n_participants),
          paste0("Samples: ", n_samples)
        )
      )

      showRiskSuccessModal(
        title = "Predictions Generated",
        message = "Hazard sample predictions are ready. Would you like to run risk analysis now?",
        details = detail_text,
        footer = tagList(
          modalButton("Later"),
          actionButton("risk_continue_to_analysis", "Run Risk Analysis Now", class = "btn-success")
        ),
        easyClose = FALSE
      )
      TRUE
    },
    error = function(e) {
      showRiskErrorModal(
        title = "Generate Predictions Failed",
        message = "Failed to apply the risk model to the selected hazard samples.",
        details = formatOperationDetails(
          context = "Hazard prediction failure",
          extras = c(
            paste0("Risk model path: ", model_path),
            paste0("Hazard samples path: ", hazard_samples_path)
          ),
          error = e
        )
      )
      FALSE
    }
  )
}

needs_prediction_refresh <- function(selected_path) {
  if (!file.exists(risk_hazard_samples_path) || !file.exists(risk_hazard_samples_preds_path)) {
    return(FALSE)
  }
  same_file <- FALSE
  try(
    {
      same_file <- normalizePath(selected_path) == normalizePath(risk_hazard_samples_preds_path)
    },
    silent = TRUE
  )
  if (!same_file) {
    return(FALSE)
  }
  raw_info <- file.info(risk_hazard_samples_path)$mtime
  preds_info <- file.info(risk_hazard_samples_preds_path)$mtime
  raw_info > preds_info
}
# Reactive simulation data
sim_data <- reactive({
  req(input$sim_participant, input$sim_trialNum)
  participant <- input$sim_participant
  trial <- as.numeric(input$sim_trialNum)

  if (!exists("simulation", envir = .GlobalEnv)) {
    stop("Simulation feature module is not available.")
  }

  # Check if simulation data exists
  if (!has_simulation_data(participant, trial)) {
    return(NULL)
  }

  # Get the simulation data with UI parameters
  sim_data <- simulation$get_simulation_data(participant, trial)

  standardized_condition <- NULL
  standardized_phase <- NULL
  if (isTRUE(input$enable_standardized_training)) {
    if (!is.null(input$standardized_condition) && input$standardized_condition != "<current>") {
      standardized_condition <- input$standardized_condition
    }
    if (!is.null(input$standardized_phase) && input$standardized_phase != "<current>") {
      standardized_phase <- input$standardized_phase
    }
  }

  model_available <- base::exists("GLOBAL_RISK_MODEL", envir = .GlobalEnv) &&
    !is.null(base::get("GLOBAL_RISK_MODEL", envir = .GlobalEnv))
  if (isTRUE(input$enable_risk_predictions) && !model_available && !risk_analysis_state$model_modal_shown) {
    risk_analysis_state$model_modal_shown <- TRUE
    showRiskModal(
      title = "Risk Model Required",
      body = tagList(
        tags$p("A loaded risk model is required to generate predictions with the current settings."),
        tags$pre(formatOperationDetails(
          context = "Missing risk model",
          extras = c(
            paste0(
              "Selected model file: ",
              ifelse(is.null(input$risk_model_file), "<none>", input$risk_model_file)
            )
          )
        ))
      ),
      footer = tagList(
        modalButton("Cancel"),
        actionButton("modal_load_model", "Load Selected Model", class = "btn-primary")
      ),
      size = "m",
      easyClose = TRUE
    )
  }
  force_direct_model <- isTRUE(input$enable_risk_predictions) && model_available

  sim_data <- simulation$add_risk_predictions(sim_data,
    enable_risk = input$enable_risk_predictions,
    allow_direct_model = model_available,
    standardized_condition = standardized_condition,
    standardized_phase = standardized_phase,
    force_direct_model = force_direct_model
  )
  return(sim_data)
})

# Update data availability status
output$sim_data_status <- renderText({
  req(input$sim_participant, input$sim_trialNum)
  participant <- input$sim_participant
  trial <- as.numeric(input$sim_trialNum)

  tryCatch(
    {
      if (has_simulation_data(participant, trial)) {
        # Use the reactive sim_data instead of calling get_simulation_data again
        data <- sim_data()
        if (!is.null(data) && nrow(data) > 0) {
          n_real <- sum(data$simulating, na.rm = TRUE)
          n_respawns <- length(unique(data$respawn_segment)) - 1
          paste0(
            "✓ Simulation data available: ", nrow(data), " total samples (", n_real, " on plate, ", n_respawns, " ball falls), arcDeg = ",
            paste(unique(data$arcDeg), collapse = ", ")
          )
        } else {
          "✗ Error loading simulation data"
        }
      } else {
        "✗ No simulation data available for this participant/trial"
      }
    },
    error = function(e) {
      paste("✗ Error checking simulation data:", e$message)
    }
  )
})

# Update variable choices when data changes
observe({
  req(input$sim_participant, input$sim_trialNum)

  # Use the reactive sim_data instead of calling get_simulation_data again
  data <- sim_data()
  if (is.null(data) || nrow(data) == 0) {
    updateSelectizeInput(session, "sim_vars", choices = NULL, selected = NULL)
    return()
  }

  if (!exists("simulation", envir = .GlobalEnv)) {
    updateSelectizeInput(session, "sim_vars", choices = NULL, selected = NULL)
    return()
  }

  # Update available variables
  available_vars <- simulation$get_simulation_variable_choices(data)
  if (!is.null(available_vars)) {
    # Preserve previously selected variables if they still exist
    prev <- isolate(input$sim_vars)
    keep <- intersect(prev, available_vars)
    if (length(keep) == 0) {
      keep <- intersect(c("q", "x", "dist_to_escape_ratio", "drop_risk_1s"), available_vars)
      if (length(keep) == 0) keep <- available_vars[1]
    }
    updateSelectizeInput(session, "sim_vars",
      choices = available_vars,
      selected = keep
    )
  }
})

# Update standardized condition and phase choices when data changes
observe({
  req(input$sim_participant, input$sim_trialNum)

  # Use the reactive sim_data to get available conditions and phases
  data <- sim_data()

  # Helper to collect available conditions/phases from the richest source we have
  get_available_levels <- function(column_name, data_fallback = NULL) {
    levels <- character(0)

    if (exists("GLOBAL_HAZARD_SAMPLES_PREDS", envir = .GlobalEnv) &&
      !is.null(.GlobalEnv$GLOBAL_HAZARD_SAMPLES_PREDS) &&
      column_name %in% names(.GlobalEnv$GLOBAL_HAZARD_SAMPLES_PREDS)) {
      levels <- unique(as.character(.GlobalEnv$GLOBAL_HAZARD_SAMPLES_PREDS[[column_name]]))
    } else if (!is.null(data_fallback) && column_name %in% names(data_fallback)) {
      levels <- unique(as.character(data_fallback[[column_name]]))
    }

    levels <- sort(levels[!is.na(levels) & nzchar(levels)])
    levels
  }

  available_conditions <- get_available_levels("condition", data)
  if (length(available_conditions) == 0 && !is.null(condition_map)) {
    available_conditions <- sort(names(condition_map))
  }

  available_phases <- get_available_levels("phase", data)
  if (length(available_phases) == 0 && exists("phase_map", envir = .GlobalEnv)) {
    available_phases <- sort(names(.GlobalEnv$phase_map))
  }

  condition_choices <- c("Keep current" = "<current>", setNames(available_conditions, available_conditions))
  phase_choices <- c("Keep current" = "<current>", setNames(available_phases, available_phases))

  updateSelectizeInput(
    session,
    "standardized_condition",
    choices = condition_choices,
    selected = if (!is.null(input$standardized_condition) && input$standardized_condition %in% names(condition_choices)) {
      input$standardized_condition
    } else {
      "<current>"
    },
    server = FALSE
  )

  updateSelectizeInput(
    session,
    "standardized_phase",
    choices = phase_choices,
    selected = if (!is.null(input$standardized_phase) && input$standardized_phase %in% names(phase_choices)) {
      input$standardized_phase
    } else {
      "<current>"
    },
    server = FALSE
  )
})

# Time series plot
output$sim_tsPlot <- renderPlotly({
  data <- sim_data()
  vars <- input$sim_vars
  if (is.null(data) || nrow(data) == 0 || length(vars) == 0) {
    return(plotly::plot_ly() %>% layout(title = "No data/variables selected"))
  }

  if (!exists("simulation", envir = .GlobalEnv)) {
    return(plotly::plot_ly() %>% layout(title = "Simulation module not available"))
  }
  var_name_map <- simulation$get_simulation_variable_names()

  # Use the plotting function
  tryCatch(
    {
      plotting$plot_simulation_timeseries(
        data = data,
        vars = vars,
        downsampling = input$sim_downsampling,
        plot_width = input$plotwidth,
        plot_height = input$plotheight,
        var_name_map = var_name_map
      )
    },
    error = function(e) {
      plot_ly() %>% layout(title = paste("Error:", e$message))
    }
  )
})

# Update risk model file choices
observe({
  # Get all .rds files in the data_extra directory
  if (dir.exists(dataExtraFolder)) {
    model_files <- list.files(dataExtraFolder, pattern = "\\.rds$", full.names = FALSE)
    # Filter for risk model files
    risk_model_files <- model_files[grepl("risk_model", model_files, ignore.case = TRUE)]

    if (length(risk_model_files) > 0) {
      # Set default to the main risk model file if it exists
      default_file <- if ("risk_model_v1.rds" %in% risk_model_files) "risk_model_v1.rds" else risk_model_files[1]
      updateSelectizeInput(session, "risk_model_file",
        choices = risk_model_files,
        selected = default_file
      )
    } else {
      updateSelectizeInput(session, "risk_model_file",
        choices = "No risk model files found",
        selected = NULL
      )
    }
  }
})

# Update hazard samples file choices
observe({
  # Get all .rds files in the data_extra directory
  if (dir.exists(dataExtraFolder)) {
    model_files <- list.files(dataExtraFolder, pattern = "\\.rds$", full.names = FALSE)
    # Filter for hazard samples files
    hazard_files <- model_files[grepl("hazard_samples", model_files, ignore.case = TRUE)]

    if (length(hazard_files) > 0) {
      # Set default to the main hazard samples file if it exists
      default_file <- if ("hazard_samples.rds" %in% hazard_files) "hazard_samples.rds" else hazard_files[1]
      updateSelectizeInput(session, "hazard_samples_file",
        choices = hazard_files,
        selected = default_file
      )
    } else {
      updateSelectizeInput(session, "hazard_samples_file",
        choices = "No hazard samples files found",
        selected = NULL
      )
    }
  }
})

# Load selected risk model
observeEvent(input$load_risk_model, {
  req(input$risk_model_file)

  load_risk_model_internal(input$risk_model_file, notify = TRUE)
})

observeEvent(input$modal_load_model, {
  removeModal()
  risk_analysis_state$model_modal_shown <- FALSE
  if (load_risk_model_internal(input$risk_model_file, notify = TRUE, from_modal = TRUE)) {
    # nothing else to do; modal already closed
  }
})

output$current_model_info <- renderUI({
  model_loaded <- base::exists("GLOBAL_RISK_MODEL", envir = .GlobalEnv) &&
    !is.null(base::get("GLOBAL_RISK_MODEL", envir = .GlobalEnv))
  hazard_loaded <- base::exists("GLOBAL_HAZARD_SAMPLES_PREDS", envir = .GlobalEnv) &&
    !is.null(base::get("GLOBAL_HAZARD_SAMPLES_PREDS", envir = .GlobalEnv))

  model_path <- if (!is.null(risk_analysis_state$latest_model_path)) {
    risk_analysis_state$latest_model_path
  } else if (model_loaded) {
    "<loaded from session>"
  } else {
    NULL
  }

  hazard_rows <- if (hazard_loaded) {
    nrow(base::get("GLOBAL_HAZARD_SAMPLES_PREDS", envir = .GlobalEnv))
  } else {
    0
  }
  tau_attr <- if (model_loaded) attr(base::get("GLOBAL_RISK_MODEL", envir = .GlobalEnv), "tau") else NULL

  standardized_condition <- if (!is.null(input$standardized_condition) && input$standardized_condition != "<current>") input$standardized_condition else "Keep current"
  standardized_phase <- if (!is.null(input$standardized_phase) && input$standardized_phase != "<current>") input$standardized_phase else "Keep current"

  rows <- list(
    c("Model status", if (model_loaded) "Loaded" else "Not loaded"),
    c("Model file", if (!is.null(model_path)) basename(model_path) else "<none>"),
    c("Model class", if (model_loaded) class(base::get("GLOBAL_RISK_MODEL", envir = .GlobalEnv))[1] else "-"),
    c("Model tau", if (!is.null(tau_attr)) sprintf("%.3f s", tau_attr) else "-"),
    c("Hazard predictions", if (hazard_loaded) sprintf("Loaded (%s rows)", format(hazard_rows, big.mark = ",")) else "Not loaded"),
    c("Standardized condition", standardized_condition),
    c("Standardized phase", standardized_phase)
  )

  tags$table(
    class = "table table-sm table-borderless mb-0",
    tags$tbody(lapply(rows, function(r) tags$tr(tags$th(r[1]), tags$td(r[2]))))
  )
  })

  observeEvent(input$enable_risk_predictions, {
    if (!isTRUE(input$enable_risk_predictions)) {
      risk_analysis_state$model_modal_shown <- FALSE
    }
  })

  # Risk model training
observeEvent(input$train_risk_model, {
  selected_participants <- input$filterParticipants
  selected_trials <- input$filterTrials

  if (is.null(selected_participants) || is.null(selected_trials) ||
    length(selected_participants) == 0 || length(selected_trials) == 0) {
    showRiskErrorModal(
      title = "Train Risk Model",
      message = "Select at least one participant and one trial before training the model."
    )
    return()
  }

  if (!exists("simulation", envir = .GlobalEnv)) {
    showRiskErrorModal(
      title = "Train Risk Model",
      message = "The simulation module is not available; cannot train the model."
    )
    return()
  }

  all_combinations <- expand.grid(
    participant = selected_participants,
    trial = selected_trials,
    stringsAsFactors = FALSE
  )

  has_data <- mapply(has_simulation_data, all_combinations$participant, all_combinations$trial)
  valid_combinations <- unique(all_combinations[has_data, , drop = FALSE])

  if (nrow(valid_combinations) == 0) {
    showRiskErrorModal(
      title = "Train Risk Model",
      message = "No simulation data is available for the selected participants and trials."
    )
    return()
  }

  tryCatch(
    {
      training <- withProgress(message = "Training risk model", value = 0, {
        incProgress(0.2, detail = "Collecting hazard samples across selected trials")
        model <- simulation$train_and_save_risk_model(
          participants = valid_combinations$participant,
          trials = valid_combinations$trial,
          tau = input$risk_tau,
          sampling_freq = input$sampling_freq,
          standardized_condition = if (isTRUE(input$enable_standardized_training) && length(input$standardized_condition) > 0) input$standardized_condition[1] else NULL,
          standardized_phase = if (isTRUE(input$enable_standardized_training) && length(input$standardized_phase) > 0) input$standardized_phase[1] else NULL,
          annotate_predictions = FALSE,
          compute_standardized = FALSE
        )
        incProgress(0.9, detail = "Finalising model")
        list(model = model)
      })

      model <- training$model

      if (is.null(model)) {
        showRiskErrorModal(
          title = "Train Risk Model",
          message = "The risk model could not be trained because no valid data was returned.",
          details = formatOperationDetails(
            context = "Risk model training",
            extras = c(
              paste0("Participants: ", paste(unique(valid_combinations$participant), collapse = ", ")),
              paste0("Trials: ", paste(unique(valid_combinations$trial), collapse = ", ")),
              "No usable data returned by training pipeline."
            )
          )
        )
        return()
      }

      actual_model <- if (is.list(model) && "model" %in% names(model)) model$model else model
      GLOBAL_RISK_MODEL <<- actual_model
      risk_analysis_state$latest_model_path <- risk_model_path
      risk_analysis_state$model_modal_shown <- FALSE

      if (!is.null(actual_model$model)) {
        n_obs <- nrow(actual_model$model)
      } else if (!is.null(actual_model$n)) {
        n_obs <- actual_model$n
      } else if ("frame" %in% methods::slotNames(actual_model)) {
        n_obs <- nrow(actual_model@frame)
      } else {
        n_obs <- length(fitted(actual_model))
      }

      detail_lines <- c(
        paste0("Participants used: ", length(unique(valid_combinations$participant))),
        paste0("Trials used: ", nrow(valid_combinations)),
        paste0("Observations: ", n_obs),
        paste0("Tau: ", input$risk_tau),
        paste0("Sampling frequency: ", input$sampling_freq),
        paste0("Model path: ", risk_model_path)
      )

      if (isTRUE(input$enable_standardized_training)) {
        detail_lines <- c(
          detail_lines,
          paste0("Standardised condition: ", paste(input$standardized_condition, collapse = ", ")),
          paste0("Standardised phase: ", paste(input$standardized_phase, collapse = ", "))
        )
      }

      updateSelectizeInput(session, "risk_model_file",
        selected = basename(risk_model_path)
      )

      if (file.exists(risk_hazard_samples_path)) {
        updateSelectizeInput(session, "hazard_samples_file",
          selected = basename(risk_hazard_samples_path)
        )
        risk_analysis_state$latest_hazard_path <- risk_hazard_samples_path
      }

      showRiskSuccessModal(
        title = "Risk Model Trained",
        message = "Risk model training completed successfully. Would you like to generate predictions now?",
        details = formatOperationDetails(
          context = "Risk model training",
          extras = detail_lines
        ),
        footer = tagList(
          modalButton("Later"),
          actionButton("risk_continue_to_predictions", "Run Predictions Now", class = "btn-primary")
        ),
        easyClose = FALSE
      )
    },
    error = function(e) {
      showRiskErrorModal(
        title = "Train Risk Model Failed",
        message = "An error occurred while training the risk model.",
        details = formatOperationDetails(
          context = "Risk model training failure",
          extras = c(
            paste0("Participants: ", paste(unique(valid_combinations$participant), collapse = ", ")),
            paste0("Trials: ", paste(unique(valid_combinations$trial), collapse = ", "))
          ),
          error = e
        )
      )
    }
  )
})

# Load hazard samples and apply model
observeEvent(input$predict_hazard_samples, {
  req(input$risk_model_file, input$hazard_samples_file)
  performHazardPrediction(input$risk_model_file, input$hazard_samples_file)
})

observeEvent(input$risk_continue_to_predictions, {
  removeModal()
  model_file <- if (!is.null(risk_analysis_state$latest_model_path)) {
    basename(risk_analysis_state$latest_model_path)
  } else {
    input$risk_model_file
  }

  hazard_file <- if (!is.null(risk_analysis_state$latest_hazard_path) &&
    file.exists(risk_analysis_state$latest_hazard_path)) {
    basename(risk_analysis_state$latest_hazard_path)
  } else {
    input$hazard_samples_file
  }

  performHazardPrediction(model_file, hazard_file)
})

observeEvent(input$risk_continue_to_analysis, {
  removeModal()

  model_path <- if (!is.null(risk_analysis_state$latest_model_path)) {
    risk_analysis_state$latest_model_path
  } else if (!is.null(input$risk_model_file) && !identical(input$risk_model_file, "No risk model files found")) {
    file.path(dataExtraFolder, input$risk_model_file)
  } else {
    NULL
  }

  hazard_path <- if (!is.null(risk_analysis_state$latest_hazard_path)) {
    risk_analysis_state$latest_hazard_path
  } else if (!is.null(input$hazard_samples_file) && !identical(input$hazard_samples_file, "No hazard samples files found")) {
    file.path(dataExtraFolder, input$hazard_samples_file)
  } else {
    NULL
  }

  if (is.null(model_path) || !file.exists(model_path) ||
    is.null(hazard_path) || !file.exists(hazard_path)) {
    showRiskErrorModal(
      title = "Perform Risk Analysis",
      message = "Required files could not be found. Please verify selections before continuing.",
      details = formatOperationDetails(
        context = "Risk analysis quick-start validation",
        extras = c(
          paste0("Model path: ", if (is.null(model_path)) "<missing>" else model_path),
          paste0("Hazard samples path: ", if (is.null(hazard_path)) "<missing>" else hazard_path)
        )
      )
    )
    return()
  }

  risk_analysis_state$pending <- NULL
  runRiskAnalysis(model_path, hazard_path)
})

# Perform Risk Analysis button handler
observeEvent(input$perform_risk_analysis, {
  req(input$risk_model_file, input$hazard_samples_file)

  if (identical(input$risk_model_file, "No risk model files found")) {
    showRiskErrorModal(
      title = "Perform Risk Analysis",
      message = "Select a valid risk model file before running the analysis."
    )
    return()
  }

  if (identical(input$hazard_samples_file, "No hazard samples files found")) {
    showRiskErrorModal(
      title = "Perform Risk Analysis",
      message = "Select a valid hazard samples file before running the analysis."
    )
    return()
  }

  model_path <- file.path(dataExtraFolder, input$risk_model_file)
  hazard_samples_path <- file.path(dataExtraFolder, input$hazard_samples_file)

  if (!file.exists(model_path)) {
    showRiskErrorModal(
      title = "Perform Risk Analysis",
      message = "The selected risk model file could not be found.",
      details = formatOperationDetails(
        context = "Risk analysis validation",
        extras = paste0("Missing model path: ", model_path)
      )
    )
    return()
  }

  if (!file.exists(hazard_samples_path)) {
    showRiskErrorModal(
      title = "Perform Risk Analysis",
      message = "The selected hazard samples file could not be found.",
      details = formatOperationDetails(
        context = "Risk analysis validation",
        extras = paste0("Missing hazard samples path: ", hazard_samples_path)
      )
    )
    return()
  }

  if (needs_prediction_refresh(hazard_samples_path)) {
    risk_analysis_state$pending <- list(
      model_path = model_path,
      hazard_samples_path = hazard_samples_path
    )

    detail_text <- formatOperationDetails(
      context = "Prediction refresh warning",
      extras = c(
        paste0("Selected hazard samples: ", basename(hazard_samples_path)),
        paste0("Latest predictions file: ", basename(risk_hazard_samples_preds_path))
      )
    )

    showRiskModal(
      title = "Hazard Samples May Be Outdated",
      body = tagList(
        tags$p("The base hazard samples were updated after predictions were generated."),
        tags$p("Do you want to continue with the existing predictions?"),
        tags$pre(detail_text)
      ),
      footer = tagList(
        modalButton("Cancel"),
        actionButton("confirm_risk_analysis_proceed", "Proceed Anyway", class = "btn-danger")
      ),
      easyClose = FALSE
    )
    return()
  }

  risk_analysis_state$pending <- NULL
  runRiskAnalysis(model_path, hazard_samples_path)
})

observeEvent(input$confirm_risk_analysis_proceed, {
  pending <- risk_analysis_state$pending
  if (!is.null(pending)) {
    runRiskAnalysis(pending$model_path, pending$hazard_samples_path)
    risk_analysis_state$pending <- NULL
  }
  removeModal()
})
```




